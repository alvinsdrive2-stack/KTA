generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String        @id @default(cuid())
  daerahId              String?
  name                  String
  email                 String        @unique
  password              String
  role                  UserRole      @default(DAERAH)
  isActive              Boolean       @default(true)
  ktpUrl                String?
  fotoUrl               String?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  approvals             Approval[]
  bulkPaymentsSubmitted BulkPayment[] @relation("BulkPaymentSubmittedBy")
  bulkPaymentsVerified  BulkPayment[] @relation("BulkPaymentVerifiedBy")
  ktaRequests           KTARequest[]
  sessions              Session[]
  daerah                Daerah?       @relation(fields: [daerahId], references: [id])

  @@map("users")
}

model Session {
  id           String @id @default(cuid())
  sessionToken String @unique
  userId       String
  expires      BigInt
  user         User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Daerah {
  id           String        @id @default(cuid())
  namaDaerah   String
  kodeDaerah   String        @unique
  alamat       String?
  telepon      String?
  email        String?
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  kodePropinsi String?
  diskonPersen Int           @default(0)
  bulkPayments BulkPayment[]
  ktaRequests  KTARequest[]
  regionPrices RegionPrice[]
  users        User[]

  @@map("daerah")
}

model RegionPrice {
  id        String   @id @default(cuid())
  daerahId  String
  hargaKta  Int
  tahun     Int
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  daerah    Daerah   @relation(fields: [daerahId], references: [id])

  @@unique([daerahId, tahun])
  @@map("region_prices")
}

model Subklasifikasi {
  id                 String       @id @default(cuid())
  idKlasifikasi      String
  idSubklasifikasi   String
  kodeSubklasifikasi String       @unique
  subklasifikasi     String
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  ktaRequests        KTARequest[]

  @@unique([idKlasifikasi, idSubklasifikasi])
  @@map("subklasifikasi")
}

model KTARequest {
  id                 String          @id @default(cuid())
  idIzin             String          @unique
  daerahId           String
  requestedBy        String
  nik                String
  nama               String
  jabatanKerja       String
  subklasifikasi     String?
  jenjang            String
  noTelp             String
  email              String
  alamat             String
  tanggalDaftar      DateTime
  status             KTAStatus       @default(DRAFT)
  hargaRegion        Int
  pusatApprovedBy    String?
  pusatApprovedAt    DateTime?
  kartuGeneratedPath String?
  qrCodePath         String?
  nomorKTA           String?         @unique
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  fotoUrl            String?
  ktpUrl             String?
  subklasifikasiId   String?
  diskonPersen       Int?            @default(0)
  hargaBase          Int?
  hargaFinal         Int?
  approvals          Approval[]
  documents          KTADocument[]
  daerah             Daerah          @relation(fields: [daerahId], references: [id])
  requestedByUser    User            @relation(fields: [requestedBy], references: [id])
  klasifikasi        Subklasifikasi? @relation(fields: [subklasifikasiId], references: [id])
  payments           Payment[]
  qrScans            QRScan[]

  @@map("kta_requests")
}

model KTADocument {
  id           String       @id @default(cuid())
  ktaRequestId String
  jenis        DocumentType
  link         String
  createdAt    DateTime     @default(now())
  ktaRequest   KTARequest   @relation(fields: [ktaRequestId], references: [id], onDelete: Cascade)

  @@map("kta_documents")
}

model Payment {
  id               String        @id @default(cuid())
  ktaRequestId     String
  invoiceNumber    String
  rekeningTujuan   String
  jumlah           Int
  buktiBayarLink   String?
  statusPembayaran PaymentStatus @default(PENDING)
  paidAt           DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  bulkPaymentId    String?
  bulkPayment      BulkPayment?  @relation(fields: [bulkPaymentId], references: [id])
  ktaRequest       KTARequest    @relation(fields: [ktaRequestId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model BulkPayment {
  id                 String        @id @default(cuid())
  invoiceNumber      String        @unique
  daerahId           String
  totalJumlah        Int
  totalNominal       Int
  buktiPembayaranUrl String
  status             PaymentStatus @default(PENDING)
  verifiedBy         String?
  verifiedAt         DateTime?
  submittedBy        String
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  daerah             Daerah        @relation(fields: [daerahId], references: [id])
  submittedByUser    User          @relation("BulkPaymentSubmittedBy", fields: [submittedBy], references: [id])
  verifiedByUser     User?         @relation("BulkPaymentVerifiedBy", fields: [verifiedBy], references: [id])
  payments           Payment[]

  @@map("bulk_payments")
}

model Approval {
  id             String         @id @default(cuid())
  ktaRequestId   String
  approvedBy     String
  status         ApprovalStatus
  catatan        String?
  createdAt      DateTime       @default(now())
  approvedByUser User           @relation(fields: [approvedBy], references: [id])
  ktaRequest     KTARequest     @relation(fields: [ktaRequestId], references: [id], onDelete: Cascade)

  @@map("approvals")
}

model QRScan {
  id           String     @id @default(cuid())
  ktaRequestId String
  ipAddress    String?
  userAgent    String?
  scannedAt    DateTime   @default(now())
  ktaRequest   KTARequest @relation(fields: [ktaRequestId], references: [id], onDelete: Cascade)

  @@map("qr_scans")
}

enum UserRole {
  DAERAH
  PUSAT
  ADMIN
}

enum KTAStatus {
  DRAFT
  FETCHED_FROM_SIKI
  EDITED
  WAITING_PAYMENT
  READY_FOR_PUSAT
  APPROVED_BY_PUSAT
  READY_TO_PRINT
  PRINTED
  REJECTED
}

enum DocumentType {
  KTP
  FOTO
  SERTIFIKAT
  SURAT_KETERANGAN
}

enum PaymentStatus {
  PENDING
  PAID
  VERIFIED
  REJECTED
}

enum ApprovalStatus {
  APPROVED
  REJECTED
  REVISION
}
